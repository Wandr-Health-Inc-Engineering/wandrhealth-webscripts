<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wandr Kit Advisor</title>
    <style>
        /* --- Base Container & Inputs --- */
        #wandr-quiz-container {
            width: 100%;
            max-width: 72rem;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            transform: translateY(0);
            transition: transform 0.3s ease-out;
            padding: 2.5rem;
            box-sizing: border-box;
            margin: 2rem auto;
            font-family: inherit;
        }

        #wandr-quiz-container select,
        #wandr-quiz-container input[type="number"],
        #wandr-quiz-container input[type="text"],
        #wandr-quiz-container input[type="email"],
        #wandr-quiz-container input[type="tel"] {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            background-color: #f9fafb;
            font-size: 1rem;
            color: #111827;
            transition: border-color 0.2s, box-shadow 0.2s;
            box-sizing: border-box;
        }
        
        .quantity-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .quantity-selector button {
            background-color: #e5e7eb;
            border: 1px solid #d1d5db;
            color: #4b5563;
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .quantity-selector button:hover {
            background-color: #d1d5db;
        }
        
        .flex-container-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        #wandr-quiz-container select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23374151' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1rem;
        }

        #wandr-quiz-container select:focus,
        #wandr-quiz-container input[type="number"]:focus,
        #wandr-quiz-container input[type="text"]:focus,
        #wandr-quiz-container input[type="email"]:focus,
        #wandr-quiz-container input[type="tel"]:focus {
            outline: none;
            border-color: #3876d2;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }

        #wandr-quiz-container, #wandr-quiz-container div, #wandr-quiz-container p, #wandr-quiz-container button, #wandr-quiz-container a, #wandr-quiz-container h2, #wandr-quiz-container h3, #wandr-quiz-container strong, #wandr-quiz-container ul, #wandr-quiz-container li, #wandr-quiz-container select, #wandr-quiz-container input { font: inherit; vertical-align: baseline; }
        #wandr-quiz-container * { box-sizing: border-box; margin: 0; padding: 0; border: 0; }
        #wandr-quiz-container h2 { font-size: 1.5rem; line-height: 2rem; font-weight: 600; text-align: center; }
        #wandr-quiz-container h3 { font-size: 1.125rem; line-height: 1.75rem; font-weight: 500; }
        #wandr-quiz-container strong { font-weight: 600; }
        #wandr-quiz-container .font-semibold { font-weight: 500; }
        #wandr-quiz-container .text-center { text-align: center; }
        #wandr-quiz-container .text-gray-600 { color: #4b5563; }
        #wandr-quiz-container .text-blue-600 { color: #3876d2; }
        #wandr-quiz-container .text-white { color: #ffffff; }
        #wandr-quiz-container .mt-2 { margin-top: 0.25rem; }
        #wandr-quiz-container .mt-3 { margin-top: 1.5rem; }
        #wandr-quiz-container .mt-4 { margin-top: 1rem; }
        #wandr-quiz-container .mt-8 { margin-top: 2rem; }
        #wandr-quiz-container .bg-blue-600 { background-color: #3876d2; }
        #wandr-quiz-container .bg-gray-200 { background-color: #e5e7eb; }
        #wandr-quiz-container .rounded-lg { border-radius: 0.5rem; }
        #wandr-quiz-container .flex { display: flex; }
        #wandr-quiz-container .justify-between { justify-content: space-between; }
        #wandr-quiz-container .items-center { align-items: center; }
        #wandr-quiz-container .gap-4 { gap: 1rem; }
        #wandr-quiz-container .flex-wrap { flex-wrap: wrap; }
        #wandr-quiz-container .bg-gray-50 { background-color: #f9fafb; }
        #wandr-quiz-container .border-dashed { border: 1px dashed #d1d5db; }
        
        /* Reduce boldness of Destination and Trip duration */
         #page-2 .quiz-form-section h3 {
        font-weight: 500 !important; /* Use !important to ensure override */
         }
         
        /* --- Page 4 Layout --- */
        .last-page-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
        @media (min-width: 768px) {
            .last-page-grid {
                grid-template-columns: 1fr 1fr;
            }
            #price-summary-column {
                padding-left: 2rem;
            }
            #meds-list-column {
                padding-right: 2rem;
            }
            .full-width {
                grid-column: 1 / -1; 
                padding: 0 10% !important; 
            }
        }
        
        #country-info-wrapper {
            margin-bottom: 1.5rem; 
        }

        #country-info-wrapper .country-header { 
            display: flex; 
            flex-direction: column; 
            align-items: flex-start;
            gap: 1rem; 
            padding-bottom: 1rem; 
            border-bottom: 1px solid #e5e7eb; 
            margin-bottom: 2rem;
            text-align: left;
        }
        @media (min-width: 768px) { #country-info-wrapper .country-header { flex-direction: row; } }
        #country-info-wrapper .country-details { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.25rem 1.5rem; width: 100%; }
        #country-info-wrapper .country-details h2 { grid-column: 1 / -1; margin-bottom: 0.5rem; text-align: left; font-size: 1.75rem; font-weight: 600;}
        #country-info-wrapper .country-details div { font-size: 0.875rem; }
        
        /* --- Medication Lists & Pricing (Fix 3: Spacing & Styling) --- */
        .medication-item {
            display: flex;
            justify-content: space-between;
            align-items: center; /* Center items vertically */
            /* Increased padding for more white space between items */
            padding: 1.25rem; 
            border-bottom: 1px solid #e5e7eb;
            font-weight: 500;
        }

        /* ADD THIS NEW, HIGH-SPECIFICITY RULE */
        #medication-list .medication-item {
         /* Set a very generous padding value */
         padding: 0.5rem 0 !important; /* Force a clear separation, using !important for testing */
        }

        .medication-item:last-child {
            border-bottom: none;
        }
        
        /* Container for Name/Ailment/Quantity */
        .medication-item > div {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        /* Drug Name + Ailment (Fix 4) */
        .med-name-ailment {
            font-weight: 500; 
            color: #6b7280;
            font-size: 1rem;
            line-height: 1.2;
            margin-bottom: 0.25rem;
        }
        
        /* Quantity Subtext (Fix 4) */
        .med-details {
            display: block;
            font-size: 1rem;
            color: #6b7280; 
            font-weight: 400; 
            margin-top: 0.30rem; 
            margin-bottom: 0.30rem;
            line-height: 1.2;
        }
        
        .price-comparison {
    margin-top: 2rem;
    /* Increase vertical padding inside the grey box for better centering */
    padding-top: 3rem; 
    padding-bottom: 3rem;
    padding-left: 2rem;
    padding-right: 2rem;
    background-color: #e2e8f0;
    border-radius: 0.5rem;
    text-align: center;
}
        /* FORCE LINE HEIGHT FOR BETTER VERTICAL SEPARATION */
#price-summary-column .price-comparison {
    line-height: 1.2; /* Increase the line height significantly to spread text */
}

 /* --- FIX 1: Price Comparison Item Spacing (Page 4 Summary Box) --- */

/* Use high specificity to ensure padding is applied */
#price-summary .comparison-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    /* ADDED: 2rem horizontal padding here to force the content away from the sides. 
       Used !important just to ensure it overrides any conflicting rule from Bootstrap-like utility classes. */
    padding: 0.25rem 2rem !important; 
}

/* Force removal of the .mt-3 margin on the first line item */
#price-summary .comparison-item.mt-3 {
    margin-top: 0 !important;
    padding-top: 1rem !important; /* Add space below the title */
}

/* Add the distinct separation line and extra space above "You save" */
#price-summary .comparison-item:nth-child(4) {
    padding-top: 1.5rem !important; 
    border-top: 1px solid #d1d5db; 
}

/* Ensure the final "Comprehensive Kit Price" is flush with the bottom */
#price-summary .comparison-item:last-child {
    padding-bottom: 0 !important; 
}
        
        /* Ensure the main title is centered above the list */
        .price-comparison .sub-title {
            text-align: center;
            margin-bottom: 0.5rem;
        }

        .strikethrough {
            text-decoration: line-through;
            color: #6b7280;
        }
        .discount-price {
            font-size: 1.5rem;
            color: #3876d2;
            font-weight: 400;
        }
        /* --- New: Change Country Link Styling --- */
.change-country-link {
    display: block; /* Make it take up its own line */
    width: 100%;
    text-align: center;
    font-size: 0.9rem;
    color: #6b7280; /* Medium gray text */
    margin-top: 1rem; /* Space it out from the button above */
    /* FIX 3: Increased padding from 1.25rem to 2rem */
    padding-top: 2rem; 
    padding-bottom: 1.25rem;
    text-decoration: underline; /* Standard link look */
    cursor: pointer;
    font-weight: 500;
    transition: color 0.2s;
}

.change-country-link:hover {
    color: #3876d2; /* Light blue on hover for feedback */
}

        /* --- Buttons --- */
        .pill-button {
            border-radius: 9999px;
            padding: 0.75rem 1.5rem !important;
        }
        .error-border {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2) !important;
        }

       /* --- Quiz Navigation Buttons --- */
        .page-buttons {
            margin-top: 2rem;
            display: flex;
            justify-content: space-between; 
            width: 100%;
        }
        
        .page-buttons.last-page {
            flex-direction: column;
            align-items: center;
        }

        /* Last Page Button Sizing */
        #individual-meds-button {
            display: block;
            width: 100%;
            margin-top: 0.5rem;
            color: #4b5563;
            background-color: #e5e7eb;
            border: 1px solid #d1d5db;
            font-weight: 500;
            text-align: center;
            font-size: 1rem;
            border-radius: 9999px;
            cursor: pointer;
            height: 48px;
        }
        #individual-meds-button:hover {
            background-color: #d1d5db;
        }
        #order-kit-button {
            width: 100%;
            margin-top: 1rem;
            height: 48px;
        }
        
        /* --- Choice Pills (Malaria, Altitude, Allergy, Individual Meds) --- */
        
        .malaria-question-container, .altitude-question-container {
             display: grid;
             grid-template-columns: 1fr;
             gap: 0.75rem;
        }
        
        /* NEW: Grid for Allergy Options (Defaults to 1 column, 3 columns on desktop) */
        .allergy-grid {
             display: grid;
             grid-template-columns: 1fr;
             gap: .5rem;
             padding-top: 1.25rem;
             padding-bottom: 1.25rem;
             margin-bottom: 1rem; /* Space before the full-width button */
        }
        @media (min-width: 768px) {
            .allergy-grid {
                 /* 3 columns on larger screens */
                 grid-template-columns: repeat(3, 1fr); 
            }
        }
        /* New: Full-width button style for "No known allergies" */
        .full-width-pill {
            display: block;
            width: 100%;
        }

        .medication-card, 
        #page-2b .malaria-option, 
        #page-3 .altitude-option, 
        .allergy-option {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            /* CONFIRMED: 2rem padding for left/right spacing */
            padding: 1.25rem 2rem; 
            cursor: pointer;
            transition: all 0.2s ease-in-out;
             background-color: #f9fafb;
            /* Ensure flex container properties are set for internal alignment */
            text-align: left; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            /* This is the base color for the medication card */
            color: #111827; 
            
        }

        .medication-card > div {
            /* Explicitly align text left inside the text column */
            text-align: left; 
            display: flex; 
            flex-direction: column;
            align-items: flex-start;
        }
        
        /* FIX 4A: Ensure UNSELECTED Price Text is NAVY and the whole card is not white */
        /* This high-specificity rule is needed because the price span has default styling */
        #individual-meds-selection .medication-card:not(.selected) span:last-child {
             color: #384b80; 
        }

        /* This is the existing rule to make the unselected text dark, but we added a more specific rule above for the price span */
        #individual-meds-selection .medication-card h6,
        #individual-meds-selection .medication-card .med-details {
             color: #384b80; 
        }

        /* FIX: Centering for single-text choice pills (Malaria & Altitude) */
        #page-2b .malaria-option, 
        #page-3 .altitude-option {
            /* Override space-between and force center alignment */
            justify-content: center !important; 
            /* Ensure the text itself is centered */
            text-align: center !important; 
        }

      /* ADD THIS NEW BLOCK to override the padding ONLY for the Allergy Pills */
#page-3b .allergy-option {
    /* Significantly increase the top/bottom padding for a taller pill */
    padding-top: 0.5rem;
    padding-bottom: 0.5rem;
    
    /* Ensure the left/right padding remains consistent */
    padding-left: 0.5rem;
    padding-right: 0.5rem;
    
    /* Add a 1px solid border with 50% opaque blue*/
    border: 1px solid #e5e7eb;

    /* Set line-height to normal so it doesn't interfere with the new padding */
    line-height: normal; 
}

        .allergy-option {
            /* Modified to ensure pill text is centered for the new layout */
            text-align: center; 
            justify-content: center;
        }
        
        .medication-card:hover {
            border-color: #3876d2;
            background-color: #f2f5f9;
        }
        
        .medication-card.selected, 
        #page-2b .malaria-option.selected, 
        #page-3 .altitude-option.selected, 
        .allergy-option.selected {
            border-color: #3876d2;
            background-color: #3876d2;
            padding-top: 1rem;
            padding-bottom: 1rem;
            color: #ffffff;
        }
        
        /* FIX 4B: Force ALL text inside a SELECTED card to white */
        .medication-card.selected h6, 
        .medication-card.selected span, 
        .medication-card.selected .med-details,
        .medication-card.selected span:last-child {
            color: #ffffff !important;
        }

        .individual-med-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.75rem;
            margin-bottom: 2rem;
        }

        /* --- Progress Bar (Hidden) --- */
        .progress-container {
            display: none !important; 
        }

        /* --- Individual Med Section (Increased Width and Center) --- */
        #individual-meds-selection h2, #individual-meds-selection p {
            text-align: center;
        }
        #individual-meds-selection .individual-med-grid,
        #individual-meds-selection .price-comparison,
        #individual-meds-selection .page-buttons {
            text-align: left;
            max-width: min(950px, 97%); 
            margin-left: auto;
            margin-right: auto;
        }

        /* Hide titles for refactoring */
        .travel-prep-title {
            display: none !important;
        }
        
    </style>
</head>
<body>

    <div id="wandr-quiz-container">
        <div id="page-1">
            <h2 class="quiz-title">Plan Smarter, Travel Safer</h2>
            <p class="mt-2 text-center text-gray-600 quiz-text" style="font-size: 1.125rem; font-weight: normal;">Skip the guesswork. Physician built recommendations built for your destination and travel style.</p>
            <div class="mt-4 quiz-form-section" style="display: grid; grid-template-columns: 1fr; gap: 1rem;">
                <input type="text" id="first-name" placeholder="First Name" required style="padding: 0.75rem;">
                <input type="text" id="last-name" placeholder="Last Name" required style="padding: 0.75rem;">
                <input type="email" id="email" placeholder="Email Address" required style="padding: 0.75rem;">
                <input type="tel" id="phone" placeholder="Phone Number" required pattern="[0-9]{10}" title="Phone number must be 10 digits" style="padding: 0.75rem;">
            </div>
            <div class="text-center"><button data-action="start" id="start-button" class="mt-8 bg-blue-600 text-white font-semibold pill-button">Start Planning</button></div>
        </div>
        <div id="page-2" style="display: none;">
            <h2 class="quiz-title">Choose a Destination</h2>
            <div class="mt-4 quiz-form-section">
                <h3>Destination</h3>
                <select id="country-select">
                    <option value="" disabled selected>Select a Country</option>
                </select>
                <h3 class="mt-4">Trip Duration (in days)</h3>
                <div class="flex-container-right">
                    <input type="number" id="duration-input" min="1" value="7" placeholder="Number of days" style="width: 100px;">
                    <div class="quantity-selector">
                        <button id="duration-minus">-</button>
                        <button id="duration-plus">+</button>
                    </div>
                </div>
            </div>
            <div class="page-buttons"><button data-action="back-to-p1" class="mt-8 bg-gray-200 text-gray-600 font-semibold pill-button">Back</button><button data-action="next-from-p2" class="mt-8 bg-blue-600 text-white font-semibold pill-button">Next</button></div>
        </div>
        <div id="page-2b" style="display: none;">
            <h2 class="quiz-title">Malaria Prophylaxis</h2>
            <p class="mt-2 text-center text-gray-600 quiz-text" style="font-size: 1.125rem; font-weight: normal;">Your selected destination has a risk of malaria. Are you seeking malaria prophylaxis medication?</p>
            <div class="mt-4 malaria-question-container quiz-form-section">
                <div class="malaria-option" data-selection="yes">Yes</div>
                <div class="malaria-option" data-selection="no">No</div>
            </div>
            <div class="page-buttons"><button data-action="back-to-p2" class="mt-8 bg-gray-200 text-gray-600 font-semibold pill-button">Back</button><button data-action="next-from-p2b" class="mt-8 bg-blue-600 text-white font-semibold pill-button">Next</button></div>
        </div>
        <div id="page-3" style="display: none;">
            <h2 class="quiz-title">High Altitude Travel</h2>
            <p class="mt-2 text-center text-gray-600 quiz-text" style="font-size: 1.125rem; font-weight: normal;">Will your trip involve traveling above 8,000 ft (2,500m)?</p>
            <div class="mt-4 altitude-question-container quiz-form-section">
                <div class="altitude-option" data-selection="yes">Yes</div>
                <div class="altitude-option" data-selection="no">No</div>
            </div>
            <div class="page-buttons"><button data-action="back-to-p2b" class="mt-8 bg-gray-200 text-gray-600 font-semibold pill-button">Back</button><button data-action="next-from-p3" class="mt-8 bg-blue-600 text-white font-semibold pill-button">Next</button></div>
        </div>
        <div id="page-3b" style="display: none;">
            <h2 class="quiz-title">Allergies</h2>
            <p class="mt-2 text-center text-gray-600 quiz-text" style="font-size: 1.125rem; font-weight: normal;">Are you allergic to any of the following? <span class="text-gray-600">(Select all that apply)</span></p>
            <div class="mt-4 quiz-form-section">
                 <div id="allergy-options-grid-container" class="allergy-grid">
                    </div>
                 <div id="no-allergy-option" class="allergy-option selected full-width-pill" data-allergy="none" style="margin-top: 1.25rem;">No known allergies</div>
            </div>
            <div class="page-buttons"><button data-action="back-to-p3" class="mt-8 bg-gray-200 text-gray-600 font-semibold pill-button">Back</button><button data-action="get-results" class="mt-8 bg-blue-600 text-white font-semibold pill-button">View Your Recommendations</button></div>
        </div>
        
        <div id="page-4" style="display: none;">
            <div id="country-info-wrapper">
                <div class="country-header">
                    <div class="country-details">
                        <h2 id="country-name"></h2>
                        <div><strong>Risk Level:</strong> <span id="risk-level"></span></div>
                        <div id="country-description" style="grid-column: 1 / -1; margin-top: 1rem;"></div>
                    </div>
                </div>
                <div id="malaria-alert" class="malaria-alert-container" style="display:none;"></div>
            </div>
            
            <div class="last-page-grid">
                <div class="left-column" id="meds-list-column">
                    <div id="medication-list-recommended">
                        <h2 class="quiz-title main-title">Your Recommended Kit</h2>
                        <p class="mt-2 text-center text-gray-600 quiz-text" style="font-size: 1.125rem; font-weight: normal;">Here is a comprehensive kit tailored for your trip.</p>
                        <div id="medication-list">
                            </div>
                    </div>
                    
                    <div id="individual-meds-selection" style="display:none;">
                        <h2 class="quiz-title main-title">Build Your Own Kit</h2>
                        <p class="mt-2 text-center text-gray-600 quiz-text" style="font-size: 1.125rem; font-weight: normal;">Select the individual medications you would like to purchase.</p>
                        <div class="mt-4 individual-med-grid" id="individual-meds-list">
                            </div>
                        <div id="individual-meds-price-summary" class="mt-8">
                            <div class="price-comparison">
                                <h3 class="sub-title">Your custom kit total:</h3>
                                <div class="comparison-item mt-3">
                                    <span>Total:</span>
                                    <span id="individual-meds-total-price" class="discount-price final-price">$0</span>
                                </div>
                            </div>
                        </div>
                        <div class="page-buttons" style="margin-top: 2rem;">
                            <button data-action="back-to-recommended-kit" class="mt-8 bg-gray-200 text-gray-600 font-semibold pill-button">Back to Recommended</button>
                            <button id="checkout-individual-meds-button" data-action="checkout-individual-meds" class="mt-8 bg-blue-600 text-white font-semibold pill-button" disabled>Order</button>
                        </div>
                    </div>
                </div>

                <div class="right-column" id="price-summary-column">
                    <div id="recommended-kit-summary">
                        <h2 class="quiz-title main-title">Kit Summary</h2>
                        <p class="mt-2 text-center text-gray-600 quiz-text" style="font-size: 1.125rem; font-weight: normal;">Review your savings.</p>
                        <div id="price-summary" class="mt-8">
                            <div class="price-comparison">
                                <h3 class="sub-title">The comprehensive kit includes everything you need.</h3>
                                <div class="comparison-item mt-3">
                                    <span>Total of medications bought individually:</span>
                                    <span id="medication-total-price" class="strikethrough"></span>
                                </div>
                                <div class="comparison-item">
                                    <span>Shipping:</span>
                                    <span>Free</span>
                                </div>
                                <div class="comparison-item">
                                    <span>Physician Fee:</span>
                                    <span>Included</span>
                                </div>
                                <div class="comparison-item mt-3">
                                    <span class="font-semibold text-blue-600" style="font-size: 1.1rem; font-weight: 500;">You save:</span>
                                    <span id="savings-amount" class="font-semibold text-blue-600" style="font-size: 1.1rem; font-weight: 500;"></span>
                                </div>
                                <div class="comparison-item">
                                    <span>Comprehensive Kit Price:</span>
                                    <span id="kit-price" class="discount-price final-price">$249.00</span>
                                </div>
                            </div>
                        </div>
                        <div class="page-buttons last-page">
                            <div class="page-buttons last-page">
                            <button id="order-kit-button" data-action="order-kit" class="bg-blue-600 text-white font-semibold pill-button" style="width: 100%; margin-top: 1rem; height: 48px;">Order</button>
                            <button id="individual-meds-button" data-action="individual-meds" class="bg-gray-200 text-gray-600 font-semibold pill-button" style="width: 100%; margin-top: 0.5rem; margin-bottom: 0.5rem; height: 48px;">Select Individual Medications</button>
                            <a href="#" id="change-country-link" class="change-country-link">Change Country</a> 
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="progress-container">
            <div class="progress" style="height: 0.75rem;">
                <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
        </div>
        
        </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const pages = {
                'page-1': document.getElementById('page-1'),
                'page-2': document.getElementById('page-2'),
                'page-2b': document.getElementById('page-2b'),
                'page-3': document.getElementById('page-3'),
                'page-3b': document.getElementById('page-3b'),
                'page-4': document.getElementById('page-4')
            };

            // --- UI Element References ---
            const firstNameInput = document.getElementById('first-name');
            const lastNameInput = document.getElementById('last-name');
            const emailInput = document.getElementById('email');
            const phoneInput = document.getElementById('phone');
            const startButton = document.getElementById('start-button');
            const orderKitButton = document.getElementById('order-kit-button');

            const countrySelect = document.getElementById('country-select');
            const durationInput = document.getElementById('duration-input');
            const durationMinus = document.getElementById('duration-minus');
            const durationPlus = document.getElementById('duration-plus');
            const altitudeOptions = document.querySelectorAll('#page-3 .altitude-option');
            // UPDATED REFERENCE: allergyOptionsList is no longer the main container but the old ID is now removed from the HTML
            // const allergyOptionsList = document.getElementById('allergy-options-list');
            const medicationList = document.getElementById('medication-list');
            const medicationTotalPriceEl = document.getElementById('medication-total-price');
            const countryNameEl = document.getElementById('country-name');
            const riskLevelEl = document.getElementById('risk-level');
            const countryDescriptionEl = document.getElementById('country-description');
            const malariaAlertEl = document.getElementById('malaria-alert');
            const savingsAmountEl = document.getElementById('savings-amount');
            const individualMedsButton = document.getElementById('individual-meds-button');
            const recommendedKitSection = document.getElementById('recommended-kit-summary');
            const individualMedsSection = document.getElementById('individual-meds-selection');
            const individualMedsList = document.getElementById('individual-meds-list');
            const individualMedsTotalPriceEl = document.getElementById('individual-meds-total-price');
            const checkoutIndividualMedsButton = document.getElementById('checkout-individual-meds-button');
            const recommendedMedsListContainer = document.getElementById('medication-list-recommended');
            const malariaOptions = document.querySelectorAll('#page-2b .malaria-option');
            const disclaimerContainer = document.getElementById('disclaimer-container');
            const medsListColumn = document.getElementById('meds-list-column');
            const priceSummaryColumn = document.getElementById('price-summary-column');
            const changeCountryLink = document.getElementById('change-country-link');


            // --- State Variables and Constants ---
            let malariaProphylaxisSelection = null;
            let altitudeSicknessSelection = null;
            let finalRecommendedMeds = [];

            const totalSteps = 4;
            const kitPrice = 249.00;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            const phoneRegex = /^\d{10}$/;
            const comprehensiveKitVariantId = "44633630081077";

            // Medications array (using correct prices and adding details for display)
            const medications = [
                { name: "Azithromycin", price: 69.00, quantity: "One Treatment", group: "diarrhea", risk: ['medium', 'high'], variantId: "44633631424565", ailment: "Traveler's Diarrhea (Antibiotic)" },
                { name: "Ciprofloxacin", price: 99.00, quantity: "One Treatment", group: "diarrhea-alt", risk: ['medium', 'high'], variantId: "44633631064117", ailment: "Traveler's Diarrhea (Alternative Antibiotic)" },
                { name: "Atovaquone-Proguanil", price: 159.00, quantity: "Up to 60 Travel Days", group: "malaria", risk: ['high'], variantId: "44633629589557", ailment: "Malaria Prevention" },
                { name: "Acetazolamide", price: 79.00, quantity: "Up to 60 Travel Days", group: "altitude", risk: ['altitude'], variantId: "44633631162421", ailment: "Altitude Sickness Prevention" },
                { name: "Ondansetron", price: 69.00, quantity: "30 Tablets", group: "nausea", risk: ['low', 'medium', 'high'], variantId: "44633444122677", ailment: "Nausea/Vomiting" },
                { name: "Dicyclomine", price: 99.00, quantity: "30 Tablets", group: "cramps", risk: ['low', 'medium', 'high'], variantId: "44633625034805", ailment: "Stomach Cramps" },
                { name: "Hydroxyzine", price: 69.00, quantity: "30 Tablets", group: "anxiety", risk: ['low', 'medium', 'high'], variantId: "44633538658357", ailment: "Anxiety/Sleep Aid" },
                { name: "Meclizine", price: 69.00, quantity: "30 Tablets", group: "motion-sickness", risk: ['low', 'medium', 'high'], variantId: "44633626476597", ailment: "Motion Sickness" },
                { name: "Scopolamine", price: 89.00, quantity: "3 patches", group: "motion-sickness-alt", risk: ['low', 'medium', 'high'], variantId: "44698644512821", ailment: "Motion Sickness (Patch)" },
                { name: "Clotrimazole-Betamethasone", price: 79.00, quantity: "45g Tube", group: "skin", risk: ['low', 'medium', 'high'], variantId: "44633626411061", ailment: "Fungal/Inflammation Cream" },
                { name: "Ibuprofen", price: 49.00, quantity: "30 Tablets", group: "pain", risk: ['low', 'medium', 'high'], variantId: "44633627557941", ailment: "Pain/Fever Relief" },
            ];

            const medicationLogic = [
                { name: "Azithromycin", group: "diarrhea", risks: ['medium', 'high'] },
                { name: "Ciprofloxacin", group: "diarrhea-alt", risks: ['medium', 'high'] },
                { name: "Atovaquone-Proguanil", group: "malaria", risks: ['high'] },
                { name: "Acetazolamide", group: "altitude", risks: ['altitude'] },
                { name: "Ondansetron", group: "nausea", risks: ['low', 'medium', 'high'] },
                { name: "Dicyclomine", group: "cramps", risks: ['low', 'medium', 'high'] },
                { name: "Hydroxyzine", group: "anxiety", risks: ['low', 'medium', 'high'] },
                { name: "Meclizine", group: "motion-sickness", risks: ['low', 'medium', 'high'] },
                { name: "Scopolamine", group: "motion-sickness-alt", risks: ['low', 'medium', 'high'] },
                { name: "Clotrimazole-Betamethasone", group: "skin", risks: ['low', 'medium', 'high'] },
                { name: "Ibuprofen", group: "pain", risks: ['low', 'medium', 'high'] },
            ];
            
            // Country data and malaria/altitude sets (omitted for brevity)
            const countries = [
                { value: 'Afghanistan', name: 'Afghanistan', code: '', riskLevel: 'high', description: 'A high-risk destination with complex health considerations. A comprehensive medical kit is essential for staying healthy and prepared.' },
                { value: 'Albania', name: 'Albania', code: '', riskLevel: 'low', description: 'A low-risk destination. While medical care is available, a personal medical kit is helpful for common ailments.' },
                { value: 'Algeria', name: 'Algeria', code: '', riskLevel: 'medium', description: 'A medium-risk destination. Be prepared for food and water safety concerns. A kit with medication for traveler\'s diarrhea is recommended.' },
                { value: 'Andorra', name: 'Andorra', code: '', riskLevel: 'low', description: 'A low-risk destination with high-quality medical facilities. A basic travel kit will cover common issues and minor emergencies.' },
                { value: 'Angola', name: 'Angola', code: '', riskLevel: 'high', description: 'A high-risk destination with potential for malaria and other vector-borne diseases. A comprehensive kit with strong antibiotics and malaria prevention is essential.' },
                { value: 'Antigua and Barbuda', name: 'Antigua and Barbuda', code: '', riskLevel: 'low', description: 'A low-risk destination with good healthcare. A basic kit is useful for common ailments and minor injuries you may encounter during your trip.' },
                { value: 'Argentina', name: 'Argentina', code: '', riskLevel: 'medium', description: 'A medium-risk destination. Be prepared for food and water safety concerns. A kit with medication for traveler\'s diarrhea is recommended.' },
                { value: 'Armenia', name: 'Armenia', code: '', riskLevel: 'medium', description: 'A medium-risk destination. While generally safe, the region can present risks of traveler\'s diarrhea and other infections. This kit will help you stay healthy.' },
                { value: 'Australia', name: 'Australia', code: 'au', riskLevel: 'low', description: 'A low-risk destination with excellent healthcare. A basic kit is useful for common ailments and minor injuries you may encounter during your trip.' },
                { value: 'Austria', name: 'Austria', code: '', riskLevel: 'low', description: 'A low-risk destination with high-quality medical facilities. A basic travel kit will cover common issues and minor emergencies.' },
                { value: 'Azerbaijan', name: 'Azerbaijan', code: '', riskLevel: 'medium', description: 'A medium-risk destination. While generally safe, the region can present risks of traveler\'s diarrhea and other infections. This kit will help you stay healthy.' },
                { value: 'Bahamas', name: 'Bahamas', code: '', riskLevel: 'low', description: 'A low-risk destination with good healthcare. A basic kit is useful for common ailments and minor injuries you may encounter during your trip.' },
                { value: 'Bahrain', name: 'Bahrain', code: '', riskLevel: 'low', description: 'A low-risk destination with good healthcare. A basic kit is useful for common ailments and minor injuries you may encounter during your trip.' },
                { value: 'Bangladesh', name: 'Bangladesh', code: '', riskLevel: 'high', description: 'A high-risk destination. Our comprehensive kit is essential for staying healthy in a diverse and challenging environment.' },
                { value: 'Barbados', name: 'Barbados', code: '', riskLevel: 'low', description: 'A low-risk destination with good healthcare. A basic kit is useful for common ailments and minor injuries you may encounter during your trip.' },
                { value: 'Belarus', name: 'Belarus', code: '', riskLevel: 'low', description: 'A low-risk destination. While medical care is available, a personal medical kit is helpful for common ailments.' },
                { value: 'Belgium', name: 'Belgium', code: '', riskLevel: 'low', description: 'A low-risk destination with high-quality medical facilities. A basic travel kit will cover common issues and minor emergencies.' },
                { value: 'Belize', name: 'Belize', code: '', riskLevel: 'medium', description: 'A medium-risk destination. Be prepared for food and water safety concerns. A kit with medication for traveler\'s diarrhea is recommended.' },
                { value: 'Benin', name: 'Benin', code: '', riskLevel: 'high', description: 'A high-risk destination with potential for malaria and other vector-borne diseases. A comprehensive kit with strong antibiotics and malaria prevention is essential.' },
                { value: 'Bhutan', name: 'Bhutan', code: '', riskLevel: 'medium', description: 'A medium-risk destination. While generally safe, the tropical environment can present risks of traveler\'s diarrhea and other infections. This kit will help you stay healthy.' },
                { value: 'Bolivia', name: 'Bolivia', code: '', riskLevel: 'high', description: 'A high-risk destination, especially if traveling to high altitudes or remote jungle areas. This kit is tailored for travelers who need to be prepared for various risks.' },
                { value: 'Bosnia and Herzegovina', name: 'Bosnia and Herzegovina', code: '', riskLevel: 'low', description: 'A low-risk destination. While medical care is available, a personal medical kit is helpful for common ailments.' },
                { value: 'Botswana', name: 'Botswana', code: '', riskLevel: 'high', description: 'A high-risk destination with a significant risk of malaria. Our high-risk kit is designed to provide comprehensive protection against common and serious travel illnesses.' },
                { value: 'Brazil', name: 'Brazil', code: 'br', riskLevel: 'high', description: 'A high-risk destination with potential for malaria and other vector-borne diseases. A comprehensive kit with strong antibiotics and malaria prevention is essential.' },
                { value: 'Brunei', name: 'Brunei', code: '', riskLevel: 'low', description: 'A low-risk destination with good healthcare. A basic kit is useful for common ailments and minor injuries you may encounter during your trip.' },
                { value: 'Bulgaria', name: 'Bulgaria', code: '', riskLevel: 'low', description: 'A low-risk destination with good healthcare. A basic kit is useful for common ailments and minor injuries you may encounter during your trip.' },
                { value: 'Burkina Faso', name: 'Burkina Faso', code: '', riskLevel: 'high', description: 'A high-risk destination with a significant risk of malaria. Our high-risk kit is designed to provide comprehensive protection against common and serious travel illnesses.' },
                { value: 'Burundi', name: 'Burundi', code: '', riskLevel: 'high', description: 'A high-risk destination with a significant risk of malaria. Our high-risk kit is designed to provide comprehensive protection against common and serious travel illnesses.' },
                { value: 'Cabo Verde', name: 'Cabo Verde', code: '', riskLevel: 'medium', description: 'A medium-risk destination. While generally safe, the region can present risks of traveler\'s diarrhea and other infections. This kit will help you stay healthy.' },
                { value: 'Cambodia', name: 'Cambodia', code: '', riskLevel: 'high', description: 'A high-risk destination. Travel in remote areas or during certain seasons can increase the risk of infectious diseases. A robust medical kit is a must.' },
                { value: 'Cameroon', name: 'Cameroon', code: '', riskLevel: 'high', description: 'A high-risk destination with a significant risk of malaria. Our high-risk kit is designed to provide comprehensive protection against common and serious travel illnesses.' },
                { value: 'Canada', name: 'Canada', code: 'ca', riskLevel: 'low', description: 'A low-risk destination. While medical care is readily available, a personal medical kit is crucial for pain, allergies, and general wellness on the road.' },
                { value: 'Central African Republic', name: 'Central African Republic', code: '', riskLevel: 'high', description: 'A high-risk destination with a significant risk of malaria. Our high-risk kit is designed to provide comprehensive protection against common and serious travel illnesses.' },
                { value: 'Chad', name: 'Chad', code: '', riskLevel: 'high', description: 'A high-risk destination with a significant risk of malaria. Our high-risk kit is designed to provide comprehensive protection against common and serious travel illnesses.' },
                { value: 'Chile', name: 'Chile', code: '', riskLevel: 'low', description: 'A low-risk destination. While medical care is available, a personal medical kit is helpful for common ailments.' },
                { value: 'China', name: 'China', code: '', riskLevel: 'medium', description: 'A medium-risk destination where hygiene and food safety can vary. A kit with medication for traveler\'s diarrhea is highly recommended.' },
                { value: 'Colombia', name: 'Colombia', code: '', riskLevel: 'high', description: 'A high-risk destination. Our comprehensive kit is essential for staying healthy in a diverse and challenging environment.' },
                { value: 'Comoros', name: 'Comoros', code: '', riskLevel: 'high', description: 'A high-risk destination with a significant risk of malaria. Our high-risk kit is designed to provide comprehensive protection against common and serious travel illnesses.' },
                { value: 'Congo, Democratic Republic of the', name: 'Congo, Democratic Republic of the', code: '', riskLevel: 'high', description: 'A high-risk destination with a significant risk of malaria. Our high-risk kit is designed to provide comprehensive protection against common and serious travel illnesses.' },
                { value: 'Congo, Republic of the', name: 'Congo, Republic of the', code: '', riskLevel: 'high', description: 'A high-risk destination with a significant risk of malaria. Our high-risk kit is designed to provide comprehensive protection against common and serious travel illnesses.' },
                { value: 'Costa Rica', name: 'Costa Rica', code: 'cr', riskLevel: 'medium', description: 'A medium-risk destination. While generally safe, the tropical environment can present risks of traveler\'s diarrhea and other infections. This kit will help you stay healthy.' },
                { value: 'Cote d\'Ivoire', name: 'Cote d\'Ivoire', code: '', riskLevel: 'high', description: 'A high-risk destination with a significant risk of malaria. Our high-risk kit is designed to provide comprehensive protection against common and serious travel illnesses.' },
                { value: 'Croatia', name: 'Croatia', code: '', riskLevel: 'low', description: 'A low-risk destination with good healthcare. A basic kit is useful for common ailments and minor injuries you may encounter during your trip.' },
                { value: 'Cuba', name: 'Cuba', code: '', riskLevel: 'medium', description: 'A medium-risk destination. Be prepared for food and water safety concerns. A kit with medication for traveler\'s diarrhea is recommended.' },
                { value: 'Cyprus', name: 'Cyprus', code: '', riskLevel: 'low', description: 'A low-risk destination with good healthcare. A basic kit is useful for common ailments and minor injuries you may encounter during your trip.' },
                { value: 'Czech Republic', name: 'Czech Republic', code: '', riskLevel: 'low', description: 'A low-risk destination with high-quality medical facilities. A basic travel kit will cover common issues and minor emergencies.' },
                { value: 'Denmark', name: 'Denmark', code: '', riskLevel: 'low', description: 'A low-risk destination with high-quality medical facilities. A basic travel kit will cover common issues and minor emergencies.' },
                { value: 'Djibouti', name: 'Djibouti', code: '', riskLevel: 'high', description: 'A high-risk destination with a significant risk of malaria. Our high-risk kit is designed to provide comprehensive protection against common and serious travel illnesses.' },
                { value: 'Dominica', name: 'Dominica', code: '', riskLevel: 'low', description: 'A low-risk destination with good healthcare. A basic kit is useful for common ailments and minor injuries you may encounter during your trip.' },
                { value: 'Dominican Republic', name: 'Dominican Republic', code: '', riskLevel: 'medium', description: 'A medium-risk destination. Be prepared for food and water safety concerns. A kit with medication for traveler\'s diarrhea is recommended.' },
                { value: 'Ecuador', name: 'Ecuador', code: '', riskLevel: 'medium', description: 'A medium-risk destination. While generally safe, the region can present risks of traveler\'s diarrhea and other infections. This kit will help you stay healthy.' },
                { value: 'Egypt', name: 'Egypt', code: 'eg', riskLevel: 'medium', description: 'A medium-risk destination where hygiene and food safety can vary. A kit with medication for traveler\'s diarrhea is highly recommended.' },
                { value: 'El Salvador', name: 'El Salvador', code: '', riskLevel: 'medium', description: 'A medium-risk destination. Be prepared for food and water safety concerns. A kit with medication for traveler\'s diarrhea is recommended.' },
                { value: 'Equatorial Guinea', name: 'Equatorial Guinea', code: '', riskLevel: 'high', description: 'A high-risk destination with a significant risk of malaria. Our high-risk kit is designed to provide comprehensive protection against common and serious travel illnesses.' },
                { value: 'Eritrea', name: 'Eritrea', code: '', riskLevel: 'high', description: 'A high-risk destination with a significant risk of malaria. Our high-risk kit is designed to provide comprehensive protection against common and serious travel illnesses.' },
                { value: 'Eswatini', name: 'Eswatini', code: '', riskLevel: 'high', description: 'A high-risk destination with a significant risk of malaria. Our high-risk kit is designed to provide comprehensive protection against common and serious travel illnesses.' },
                { value: 'Ethiopia', name: 'Ethiopia', code: '', riskLevel: 'high', description: 'A high-risk destination. Our comprehensive kit is essential for staying healthy in a diverse and challenging environment.' },
                { value: 'Fiji', name: 'Fiji', code: '', riskLevel: 'low', description: 'A low-risk destination with good healthcare. A basic kit is useful for common ailments and minor injuries you may encounter during your trip.' },
                { value: 'Finland', name: 'Finland', code: '', riskLevel: 'low', description: 'A low-risk destination with high-quality medical facilities. A basic travel kit will cover common issues and minor emergencies.' },
                { value: 'France', name: 'France', code: '', riskLevel: 'low', description: 'A low-risk destination with high-quality medical facilities. A basic travel kit will cover common issues and minor emergencies.' },
                { value: 'Gabon', name: 'Gabon', code: '', riskLevel: 'high', description: 'A high-risk destination with a significant risk of malaria. Our high-risk kit is designed to provide comprehensive protection against common and serious travel illnesses.' },
                { value: 'Gambia', name: 'Gambia', code: '', riskLevel: 'high', description: 'A high-risk destination with a significant risk of malaria. Our high-risk kit is designed to provide comprehensive protection against common and serious travel illnesses.' },
                { value: 'Georgia', name: 'Georgia', code: '', riskLevel: 'medium', description: 'A medium-risk destination. While generally safe, the region can present risks of traveler\'s diarrhea and other infections. This kit will help you stay healthy.' },
                { value: 'Germany', name: 'Germany', code: '', riskLevel: 'low', description: 'A low-risk destination with high-quality medical facilities. A basic travel kit will cover common issues and minor emergencies.' },
                { value: 'Ghana', name: 'Ghana', code: '', riskLevel: 'high', description: 'A high-risk destination with a significant risk of malaria. Our high-risk kit is designed to provide comprehensive protection against common and serious travel illnesses.' },
                { value: 'Greece', name: 'Greece', code: '', riskLevel: 'low', description: 'A low-risk destination with good healthcare. A basic kit is useful for common ailments and minor injuries you may encounter during your trip.' },
                { value: 'Grenada', name: 'Grenada', code: '', riskLevel: 'low', description: 'A low-risk destination with good healthcare. A basic kit is useful for common ailments and minor injuries you may encounter during your trip.' },
                { value: 'Guatemala', name: 'Guatemala', code: '', riskLevel: 'medium', description: 'A medium-risk destination. Be prepared for food and water safety concerns. A kit with medication for traveler\'s diarrhea is recommended.' },
                { value: 'Guinea', name: 'Guinea', code: '', riskLevel: 'high', description: 'A high-risk destination with a significant risk of malaria. Our high-risk kit is designed to provide comprehensive protection against common and serious travel illnesses.' },
                { value: 'Guinea-Bissau', name: 'Guinea-Bissau', code: '', riskLevel: 'high', description: 'A high-risk destination with a significant risk of malaria. Our high-risk kit is designed to provide comprehensive protection against common and serious travel illnesses.' },
                { value: 'Guyana', name: 'Guyana', code: '', riskLevel: 'high', description: 'A high-risk destination. Our comprehensive kit is essential for staying healthy in a diverse and challenging environment.' },
                { value: 'Haiti', name: 'Haiti', code: '', riskLevel: 'high', description: 'A high-risk destination with complex health considerations. A comprehensive medical kit is essential for staying healthy and prepared.' },
                { value: 'Honduras', name: 'Honduras', code: '', riskLevel: 'medium', description: 'A medium-risk destination. Be prepared for food and water safety concerns. A kit with medication for traveler\'s diarrhea is recommended.' },
                { value: 'Hungary', name: 'Hungary', code: '', riskLevel: 'low', description: 'A low-risk destination with high-quality medical facilities. A basic travel kit will cover common issues and minor emergencies.' },
                { value: 'Iceland', name: 'Iceland', code: '', riskLevel: 'low', description: 'A low-risk destination with high-quality medical facilities. A basic travel kit will cover common issues and minor emergencies.' },
                { value: 'India', name: 'India', code: 'in', riskLevel: 'high', description: 'A high-risk destination. Our comprehensive kit is essential for staying healthy in a diverse and challenging environment.' },
                { value: 'Indonesia', name: 'Indonesia', code: '', riskLevel: 'medium', description: 'A medium-risk destination. While generally safe, the tropical environment can present risks of traveler\'s diarrhea and other infections. This kit will help you stay healthy.' },
                { value: 'Iran', name: 'Iran', code: '', riskLevel: 'medium', description: 'A medium-risk destination. Be prepared for food and water safety concerns. A kit with medication for traveler\'s diarrhea is recommended.' },
                { value: 'Iraq', name: 'Iraq', code: '', riskLevel: 'high', description: 'A high-risk destination with complex health considerations. A comprehensive medical kit is essential for staying healthy and prepared.' },
                { value: 'Ireland', name: 'Ireland', code: '', riskLevel: 'low', description: 'A low-risk destination with high-quality medical facilities. A basic travel kit will cover common issues and minor emergencies.' },
                { value: 'Israel', name: 'Israel', code: '', riskLevel: 'low', description: 'A low-risk destination with high-quality medical facilities. A basic travel kit will cover common issues and minor emergencies.' },
                { value: 'Italy', name: 'Italy', code: '', riskLevel: 'low', description: 'A low-risk destination with high-quality medical facilities. A basic travel kit will cover common issues and minor emergencies.' },
                { value: 'Jamaica', name: 'Jamaica', code: '', riskLevel: 'low', description: 'A low-risk destination with good healthcare. A basic kit is useful for common ailments and minor injuries you may encounter during your trip.' },
                { value: 'Japan', name: 'Japan', code: 'jp', riskLevel: 'low', description: 'A low-risk destination with a very high standard of medical care. A basic kit provides peace of mind for common issues.' },
                { value: 'Jordan', name: 'Jordan', code: '', riskLevel: 'medium', description: 'A medium-risk destination. While generally safe, the region can present risks of traveler\'s diarrhea and other infections. This kit will help you stay healthy.' },
                { value: 'Kazakhstan', name: 'Kazakhstan', code: '', riskLevel: 'low', description: 'A low-risk destination. While medical care is available, a personal medical kit is helpful for common ailments.' },
                { value: 'Kenya', name: 'Kenya', code: 'ke', riskLevel: 'high', description: 'A high-risk destination with a significant risk of malaria. Our high-risk kit is designed to provide comprehensive protection against common and serious travel illnesses.' },
                { value: 'Kiribati', name: 'Kiribati', code: '', riskLevel: 'low', description: 'A low-risk destination with good healthcare. A basic kit is useful for common ailments and minor injuries you may encounter during your trip.' },
                { value: 'Korea, North', name: 'Korea, North', code: '', riskLevel: 'high', description: 'A high-risk destination with complex health considerations. A comprehensive medical kit is essential for staying healthy and prepared.' },
                { value: 'Korea, South', name: 'Korea, South', code: '', riskLevel: 'low', description: 'A low-risk destination with a very high standard of medical care. A basic kit provides peace of mind for common issues.' },
                { value: 'Kuwait', name: 'Kuwait', code: '', riskLevel: 'low', description: 'A low-risk destination with good healthcare. A basic kit is useful for common ailments and minor injuries you may encounter during your trip.' },
                { value: 'Kyrgyzstan', name: 'Kyrgyzstan', code: '', riskLevel: 'medium', description: 'A medium-risk destination. While generally safe, the region can present risks of traveler\'s diarrhea and other infections. This kit will help you stay healthy.' },
                { value: 'Laos', name: 'Laos', code: '', riskLevel: 'high', description: 'A high-risk destination. Travel in remote areas or during certain seasons can increase the risk of infectious diseases. A robust medical kit is a must.' },
                { value: 'Latvia', name: 'Latvia', code: '', riskLevel: 'low', description: 'A low-risk destination with good healthcare. A basic kit is useful for common ailments and minor injuries you may encounter during your trip.' },
                { value: 'Lebanon', name: 'Lebanon', code: '', riskLevel: 'medium', description: 'A medium-risk destination. Be prepared for food and water safety concerns. A kit with medication for traveler\'s diarrhea is recommended.' },
                { value: 'Lesotho', name: 'Lesotho', code: '', riskLevel: 'high', description: 'A high-risk destination. Our comprehensive kit is essential for staying healthy in a diverse and challenging environment.' },
                { value: 'Liberia', name: 'Liberia', code: '', riskLevel: 'high', description: 'A high-risk destination with a significant risk of malaria. Our high-risk kit is designed to provide comprehensive protection against common and serious travel illnesses.' },
                { value: 'Libya', name: 'Libya', code: '', riskLevel: 'high', description: 'A high-risk destination with complex health considerations. A comprehensive medical kit is essential for staying healthy and prepared.' },
                { value: 'Liechtenstein', name: 'Liechtenstein', code: '', riskLevel: 'low', description: 'A low-risk destination with high-quality medical facilities. A basic travel kit will cover common issues and minor emergencies.' },
                { value: 'Lithuania', name: 'Lithuania', code: '', riskLevel: 'low', description: 'A low-risk destination with good healthcare. A basic kit is useful for common ailments and minor injuries you may encounter during your trip.' },
                { value: 'Luxembourg', name: 'Luxembourg', code: '', riskLevel: 'low', description: 'A low-risk destination with high-quality medical facilities. A basic travel kit will cover common issues and minor emergencies.' },
                { value: 'Madagascar', name: 'Madagascar', code: '', riskLevel: 'high', description: 'A high-risk destination with a significant risk of malaria. Our high-risk kit is designed to provide comprehensive protection against common and serious travel illnesses.' },
                { value: 'Malawi', name: 'Malawi', code: '', riskLevel: 'high', description: 'A high-risk destination with a significant risk of malaria. Our high-risk kit is designed to provide comprehensive protection against common and serious travel illnesses.' },
                { value: 'Malaysia', name: 'Malaysia', code: '', riskLevel: 'medium', description: 'A medium-risk destination. While generally safe, the tropical environment can present risks of traveler\'s diarrhea and other infections. This kit will help you stay healthy.' },
                { value: 'Maldives', name: 'Maldives', code: '', riskLevel: 'medium', description: 'A medium-risk destination. Be prepared for food and water safety concerns. A kit with medication for traveler\'s diarrhea is recommended.' },
                { value: 'Mali', name: 'Mali', code: '', riskLevel: 'high', description: 'A high-risk destination with a significant risk of malaria. Our high-risk kit is designed to provide comprehensive protection against common and serious travel illnesses.' },
                { value: 'Malta', name: 'Malta', code: '', riskLevel: 'low', description: 'A low-risk destination with good healthcare. A basic kit is useful for common ailments and minor injuries you may encounter during your trip.' },
                { value: 'Marshall Islands', name: 'Marshall Islands', code: '', riskLevel: 'low', description: 'A low-risk destination with good healthcare. A basic kit is useful for common ailments and minor injuries you may encounter during your trip.' },
                { value: 'Mauritania', name: 'Mauritania', code: '', riskLevel: 'high', description: 'A high-risk destination with a significant risk of malaria. Our high-risk kit is designed to provide comprehensive protection against common and serious travel illnesses.' },
                { value: 'Mauritius', name: 'Mauritius', code: '', riskLevel: 'low', description: 'A low-risk destination with good healthcare. A basic kit is useful for common ailments and minor injuries you may encounter during your trip.' },
                { value: 'Mexico', name: 'Mexico', code: 'mx', riskLevel: 'medium', description: 'A medium-risk destination where food and water safety can be a concern. It\'s highly recommended to carry prescription medication for Traveler\'s Diarrhea and other common illnesses.' },
                { value: 'Micronesia', name: 'Micronesia', code: '', riskLevel: 'low', description: 'A low-risk destination with good healthcare. A basic kit is useful for common ailments and minor injuries you may encounter during your trip.' },
                { value: 'Moldova', name: 'Moldova', code: '', riskLevel: 'low', description: 'A low-risk destination. While medical care is available, a personal medical kit is helpful for common ailments.' },
                { value: 'Monaco', name: 'Monaco', code: '', riskLevel: 'low', description: 'A low-risk destination with high-quality medical facilities. A basic travel kit will cover common issues and minor emergencies.' },
                { value: 'Mongolia', name: 'Mongolia', code: '', riskLevel: 'low', description: 'A low-risk destination. While medical care is available, a personal medical kit is helpful for common ailments.' },
                { value: 'Montenegro', name: 'Montenegro', code: '', riskLevel: 'low', description: 'A low-risk destination. While medical care is available, a personal medical kit is helpful for common ailments.' },
                { value: 'Morocco', name: 'Morocco', code: 'ma', riskLevel: 'medium', description: 'A medium-risk destination where food and water can present a risk of illness. Be prepared with an antibiotic and other key medications.' },
                { value: 'Mozambique', name: 'Mozambique', code: '', riskLevel: 'high', description: 'A high-risk destination with a significant risk of malaria. Our high-risk kit is designed to provide comprehensive protection against common and serious travel illnesses.' },
                { value: 'Myanmar (Burma)', name: 'Myanmar (Burma)', code: '', riskLevel: 'high', description: 'A high-risk destination. Travel in remote areas or during certain seasons can increase the risk of infectious diseases. A robust medical kit is a must.' },
                { value: 'Namibia', name: 'Namibia', code: '', riskLevel: 'high', description: 'A high-risk destination with a significant risk of malaria. Our high-risk kit is designed to provide comprehensive protection against common and serious travel illnesses.' },
                { value: 'Nauru', name: 'Nauru', code: '', riskLevel: 'low', description: 'A low-risk destination with good healthcare. A basic kit is useful for common ailments and minor injuries you may encounter during your trip.' },
                { value: 'Nepal', name: 'Nepal', code: '', riskLevel: 'medium', description: 'A medium-risk destination. While generally safe, the region can present risks of traveler\'s diarrhea and other infections. This kit will help you stay healthy.' },
                { value: 'Netherlands', name: 'Netherlands', code: '', riskLevel: 'low', description: 'A low-risk destination with high-quality medical facilities. A basic travel kit will cover common issues and minor emergencies.' },
                { value: 'New Zealand', name: 'New Zealand', code: '', riskLevel: 'low', description: 'A low-risk destination with excellent healthcare. A basic kit is useful for common ailments and minor injuries you may encounter during your trip.' },
                { value: 'Nicaragua', name: 'Nicaragua', code: '', riskLevel: 'medium', description: 'A medium-risk destination. Be prepared for food and water safety concerns. A kit with medication for traveler\'s diarrhea is recommended.' },
                { value: 'Niger', name: 'Niger', code: '', riskLevel: 'high', description: 'A high-risk destination with a significant risk of malaria. Our high-risk kit is designed to provide comprehensive protection against common and serious travel illnesses.' },
                { value: 'Nigeria', name: 'Nigeria', code: '', riskLevel: 'high', description: 'A high-risk destination with a significant risk of malaria. Our high-risk kit is designed to provide comprehensive protection against common and serious travel illnesses.' },
                { value: 'North Macedonia', name: 'North Macedonia', code: '', riskLevel: 'low', description: 'A low-risk destination. While medical care is available, a personal medical kit is helpful for common ailments.' },
                { value: 'Norway', name: 'Norway', code: '', riskLevel: 'low', description: 'A low-risk destination with high-quality medical facilities. A basic travel kit will cover common issues and minor emergencies.' },
                { value: 'Oman', name: 'Oman', code: '', riskLevel: 'low', description: 'A low-risk destination with good healthcare. A basic kit is useful for common ailments and minor injuries you may encounter during your trip.' },
                { value: 'Pakistan', name: 'Pakistan', code: '', riskLevel: 'high', description: 'A high-risk destination with complex health considerations. A comprehensive medical kit is essential for staying healthy and prepared.' },
                { value: 'Palau', name: 'Palau', code: '', riskLevel: 'low', description: 'A low-risk destination with good healthcare. A basic kit is useful for common ailments and minor injuries you may encounter during your trip.' },
                { value: 'Panama', name: 'Panama', code: '', riskLevel: 'medium', description: 'A medium-risk destination. Be prepared for food and water safety concerns. A kit with medication for traveler\'s diarrhea is recommended.' },
                { value: 'Papua New Guinea', name: 'Papua New Guinea', code: '', riskLevel: 'high', description: 'A high-risk destination with a significant risk of malaria. Our high-risk kit is designed to provide comprehensive protection against common and serious travel illnesses.' },
                { value: 'Paraguay', name: 'Paraguay', code: '', riskLevel: 'medium', description: 'A medium-risk destination. While generally safe, the region can present risks of traveler\'s diarrhea and other infections. This kit will help you stay healthy.' },
                { value: 'Peru', name: 'Peru', code: 'pe', riskLevel: 'high', description: 'A high-risk destination, especially if traveling to high altitudes or remote jungle areas. This kit is tailored for travelers who need to be prepared for various risks.' },
                { value: 'Philippines', name: 'Philippines', code: '', riskLevel: 'medium', description: 'A medium-risk destination. While generally safe, the tropical environment can present risks of traveler\'s diarrhea and other infections. This kit will help you stay healthy.' },
                { value: 'Poland', name: 'Poland', code: '', riskLevel: 'low', description: 'A low-risk destination with good healthcare. A basic kit is useful for common ailments and minor injuries you may encounter during your trip.' },
                { value: 'Portugal', name: 'Portugal', code: '', riskLevel: 'low', description: 'A low-risk destination with high-quality medical facilities. A basic travel kit will cover common issues and minor emergencies.' },
                { value: 'Qatar', name: 'Qatar', code: '', riskLevel: 'low', description: 'A low-risk destination with good healthcare. A basic kit is useful for common ailments and minor injuries you may encounter during your trip.' },
                { value: 'Romania', name: 'Romania', code: '', riskLevel: 'low', description: 'A low-risk destination. While medical care is available, a personal medical kit is helpful for common ailments.' },
                { value: 'Russia', name: 'Russia', code: '', riskLevel: 'medium', description: 'A medium-risk destination. Be prepared for food and water safety concerns. A kit with medication for traveler\'s diarrhea is recommended.' },
                { value: 'Rwanda', name: 'Rwanda', code: '', riskLevel: 'high', description: 'A high-risk destination with a significant risk of malaria. Our high-risk kit is designed to provide comprehensive protection against common and serious travel illnesses.' },
                { value: 'Saint Kitts and Nevis', name: 'Saint Kitts and Nevis', code: '', riskLevel: 'low', description: 'A low-risk destination with good healthcare. A basic kit is useful for common ailments and minor injuries you may encounter during your trip.' },
                { value: 'Saint Lucia', name: 'Saint Lucia', code: '', riskLevel: 'low', description: 'A low-risk destination with good healthcare. A basic kit is useful for common ailments and minor injuries you may encounter during your trip.' },
                { value: 'Saint Vincent and the Grenadines', name: 'Saint Vincent and the Grenadines', code: '', riskLevel: 'low', description: 'A low-risk destination with good healthcare. A basic kit is useful for common ailments and minor injuries you may encounter during your trip.' },
                { value: 'Samoa', name: 'Samoa', code: '', riskLevel: 'low', description: 'A low-risk destination with good healthcare. A basic kit is useful for common ailments and minor injuries you may encounter during your trip.' },
                { value: 'San Marino', name: 'San Marino', code: '', riskLevel: 'low', description: 'A low-risk destination with high-quality medical facilities. A basic travel kit will cover common issues and minor emergencies.' },
                { value: 'Sao Tome and Principe', name: 'Sao Tome and Principe', code: '', riskLevel: 'high', description: 'A high-risk destination with a significant risk of malaria. Our high-risk kit is designed to provide comprehensive protection against common and serious travel illnesses.' },
                { value: 'Saudi Arabia', name: 'Saudi Arabia', code: '', riskLevel: 'medium', description: 'A medium-risk destination. While generally safe, the region can present risks of traveler\'s diarrhea and other infections. This kit will help you stay healthy.' },
                { value: 'Senegal', name: 'Senegal', code: '', riskLevel: 'high', description: 'A high-risk destination with a significant risk of malaria. Our high-risk kit is designed to provide comprehensive protection against common and serious travel illnesses.' },
                { value: 'Serbia', name: 'Serbia', code: '', riskLevel: 'low', description: 'A low-risk destination. While medical care is available, a personal medical kit is helpful for common ailments.' },
                { value: 'Seychelles', name: 'Seychelles', code: '', riskLevel: 'low', description: 'A low-risk destination with good healthcare. A basic kit is useful for common ailments and minor injuries you may encounter during your trip.' },
                { value: 'Sierra Leone', name: 'Sierra Leone', code: '', riskLevel: 'high', description: 'A high-risk destination with a significant risk of malaria. Our high-risk kit is designed to provide comprehensive protection against common and serious travel illnesses.' },
                { value: 'Singapore', name: 'Singapore', code: '', riskLevel: 'low', description: 'A low-risk destination with good healthcare. A basic kit is useful for common ailments and minor injuries you may encounter during your trip.' },
                { value: 'Slovakia', name: 'Slovakia', code: '', riskLevel: 'low', description: 'A low-risk destination with good healthcare. A basic kit is useful for common ailments and minor injuries you may encounter during your trip.' },
                { value: 'Slovenia', name: 'Slovenia', code: '', riskLevel: 'low', description: 'A low-risk destination. While medical care is available, a personal medical kit is helpful for common ailments.' },
                { value: 'Solomon Islands', name: 'Solomon Islands', code: '', riskLevel: 'medium', description: 'A medium-risk destination. While generally safe, the tropical environment can present risks of traveler\'s diarrhea and other infections. This kit will help you stay healthy.' },
                { value: 'Somalia', name: 'Somalia', code: '', riskLevel: 'high', description: 'A high-risk destination with complex health considerations. A comprehensive medical kit is essential for staying healthy and prepared.' },
                { value: 'South Africa', name: 'South Africa', code: '', riskLevel: 'medium', description: 'A medium-risk destination where food and water can present a risk of illness. Be prepared with an antibiotic and other key medications.' },
                { value: 'South Sudan', name: 'South Sudan', code: '', riskLevel: 'high', description: 'A high-risk destination with a significant risk of malaria. Our high-risk kit is designed to provide comprehensive protection against common and serious travel illnesses.' },
                { value: 'Spain', name: 'Spain', code: '', riskLevel: 'low', description: 'A low-risk destination with high-quality medical facilities. A basic travel kit will cover common issues and minor emergencies.' },
                { value: 'Sri Lanka', name: 'Sri Lanka', code: '', riskLevel: 'medium', description: 'A medium-risk destination. While generally safe, the tropical environment can present risks of traveler\'s diarrhea and other infections. This kit will help you stay healthy.' },
                { value: 'Sudan', name: 'Sudan', code: '', riskLevel: 'high', description: 'A high-risk destination with complex health considerations. A comprehensive medical kit is essential for staying healthy and prepared.' },
                { value: 'Suriname', name: 'Suriname', code: '', riskLevel: 'high', description: 'A high-risk destination. Our comprehensive kit is essential for staying healthy in a diverse and challenging environment.' },
                { value: 'Sweden', name: 'Sweden', code: '', riskLevel: 'low', description: 'A low-risk destination with high-quality medical facilities. A basic travel kit will cover common issues and minor emergencies.' },
                { value: 'Switzerland', name: 'Switzerland', code: '', riskLevel: 'low', description: 'A low-risk destination with high-quality medical facilities. A basic travel kit will cover common issues and minor emergencies.' },
                { value: 'Syria', name: 'Syria', code: '', riskLevel: 'high', description: 'A high-risk destination with complex health considerations. A comprehensive medical kit is essential for staying healthy and prepared.' },
                { value: 'Taiwan', name: 'Taiwan', code: '', riskLevel: 'low', description: 'A low-risk destination with good healthcare. A basic kit is useful for common ailments and minor injuries you may encounter during your trip.' },
                { value: 'Tajikistan', name: 'Tajikistan', code: '', riskLevel: 'medium', description: 'A medium-risk destination. While generally safe, the region can present risks of traveler\'s diarrhea and other infections. This kit will help you stay healthy.' },
                { value: 'Tanzania', name: 'Tanzania', code: '', riskLevel: 'high', description: 'A high-risk destination with a significant risk of malaria. Our high-risk kit is designed to provide comprehensive protection against common and serious travel illnesses.' },
                { value: 'Thailand', name: 'Thailand', code: 'th', riskLevel: 'high', description: 'A high-risk destination. Travel in remote areas or during certain seasons can increase the risk of infectious diseases. A robust medical kit is a must.' },
                { value: 'Timor-Leste', name: 'Timor-Leste', code: '', riskLevel: 'high', description: 'A high-risk destination with a significant risk of malaria. Our high-risk kit is designed to provide comprehensive protection against common and serious travel illnesses.' },
                { value: 'Togo', name: 'Togo', code: '', riskLevel: 'high', description: 'A high-risk destination with a significant risk of malaria. Our high-risk kit is designed to provide comprehensive protection against common and serious travel illnesses.' },
                { value: 'Tonga', name: 'Tonga', code: '', riskLevel: 'low', description: 'A low-risk destination with good healthcare. A basic kit is useful for common ailments and minor injuries you may encounter during your trip.' },
                { value: 'Trinidad and Tobago', name: 'Trinidad and Tobago', code: '', riskLevel: 'low', description: 'A low-risk destination with good healthcare. A basic kit is useful for common ailments and minor injuries you may encounter during your trip.' },
                { value: 'Tunisia', name: 'Tunisia', code: '', riskLevel: 'medium', description: 'A medium-risk destination. Be prepared for food and water safety concerns. A kit with medication for traveler\'s diarrhea is recommended.' },
                { value: 'Turkey', name: 'Turkey', code: '', riskLevel: 'low', description: 'A low-risk destination. While medical care is available, a personal medical kit is helpful for common ailments.' },
                { value: 'Turkmenistan', name: 'Turkmenistan', code: '', riskLevel: 'medium', description: 'A medium-risk destination. Be prepared for food and water safety concerns. A kit with medication for traveler\'s diarrhea is recommended.' },
                { value: 'Tuvalu', name: 'Tuvalu', code: '', riskLevel: 'low', description: 'A low-risk destination with good healthcare. A basic kit is useful for common ailments and minor injuries you may encounter during your trip.' },
                { value: 'Uganda', name: 'Uganda', code: '', riskLevel: 'high', description: 'A high-risk destination with a significant risk of malaria. Our high-risk kit is designed to provide comprehensive protection against common and serious travel illnesses.' },
                { value: 'Ukraine', name: 'Ukraine', code: '', riskLevel: 'low', description: 'A low-risk destination. While medical care is available, a personal medical kit is helpful for common ailments.' },
                { value: 'United Arab Emirates', name: 'United Arab Emirates', code: '', riskLevel: 'low', description: 'A low-risk destination with good healthcare. A basic kit is useful for common ailments and minor injuries you may encounter during your trip.' },
                { value: 'United Kingdom', name: 'United Kingdom', code: 'gb', riskLevel: 'low', description: 'A low-risk destination with high-quality medical facilities. A basic travel kit will cover common issues and minor emergencies.' },
                { value: 'United States', name: 'United States', code: 'us', riskLevel: 'low', description: 'Domestic travel in the United States generally carries a low risk for exotic diseases, but it\'s always smart to be prepared for common ailments like pain, allergies, and nausea.' },
                { value: 'Uruguay', name: 'Uruguay', code: '', riskLevel: 'low', description: 'A low-risk destination. While medical care is available, a personal medical kit is helpful for common ailments.' },
                { value: 'Uzbekistan', name: 'Uzbekistan', code: '', riskLevel: 'medium', description: 'A medium-risk destination. While generally safe, the region can present risks of traveler\'s diarrhea and other infections. This kit will help you stay healthy.' },
                { value: 'Vanuatu', name: 'Vanuatu', code: '', riskLevel: 'low', description: 'A low-risk destination with good healthcare. A basic kit is useful for common ailments and minor injuries you may encounter during your trip.' },
                { value: 'Vatican City', name: 'Vatican City', code: '', riskLevel: 'low', description: 'A low-risk destination with high-quality medical facilities. A basic travel kit will cover common issues and minor emergencies.' },
                { value: 'Venezuela', name: 'Venezuela', code: '', riskLevel: 'high', description: 'A high-risk destination with complex health considerations. A comprehensive medical kit is essential for staying healthy and prepared.' },
                { value: 'Vietnam', name: 'Vietnam', code: '', riskLevel: 'high', description: 'A high-risk destination. Travel in remote areas or during certain seasons can increase the risk of infectious diseases. A robust medical kit is a must.' },
                { value: 'Yemen', name: 'Yemen', code: '', riskLevel: 'high', description: 'A high-risk destination with complex health considerations. A comprehensive medical kit is essential for staying healthy and prepared.' },
                { value: 'Zambia', name: 'Zambia', code: '', riskLevel: 'high', description: 'A high-risk destination with a significant risk of malaria. Our high-risk kit is designed to provide comprehensive protection against common and serious travel illnesses.' },
                { value: 'Zimbabwe', name: 'Zimbabwe', code: '', riskLevel: 'high', description: 'A high-risk destination with a significant risk of malaria. Our high-risk kit is designed to provide comprehensive protection against common and serious travel illnesses.' },
            ];

            const malariaEndemicCountries = [
                'Afghanistan', 'Angola', 'Benin', 'Bolivia', 'Botswana', 'Brazil', 'Burkina Faso', 'Burundi',
                'Cambodia', 'Cameroon', 'Central African Republic', 'Chad', 'Colombia', 'Comoros',
                'Congo, Democratic Republic of the', 'Congo, Republic of the', 'Cote d\'Ivoire', 'Djibouti',
                'Equatorial Guinea', 'Eritrea', 'Eswatini', 'Ethiopia', 'Gabon', 'Gambia', 'Ghana', 'Guinea',
                'Guinea-Bissau', 'Guyana', 'Haiti', 'India', 'Iraq', 'Kenya', 'Laos', 'Lesotho', 'Liberia',
                'Madagascar', 'Malawi', 'Mali', 'Mauritania', 'Mozambique', 'Myanmar (Burma)', 'Namibia',
                'Niger', 'Nigeria', 'Pakistan', 'Papua New Guinea', 'Peru', 'Rwanda',
                'Sao Tome and Principe', 'Senegal', 'Sierra Leone', 'Somalia', 'South Sudan', 'Sudan',
                'Suriname', 'Syria', 'Tanzania', 'Thailand', 'Timor-Leste', 'Togo', 'Uganda', 'Venezuela',
                'Vietnam', 'Yemen', 'Zambia', 'Zimbabwe'
            ];

            const altitudeSicknessCountries = new Set(['Argentina', 'Bolivia', 'Bhutan', 'Chile', 'China', 'Colombia', 'Ecuador', 'Ethiopia', 'India', 'Kenya', 'Kyrgyzstan', 'Nepal', 'Peru', 'Rwanda', 'Tanzania', 'Uganda']);
            
            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country.name;
                option.textContent = country.name;
                countrySelect.appendChild(option);
            });
            
            // MODIFIED to include Ciprofloxacin and Scopolamine for allergy selection
            // 💡 UPDATED: Sort all drug names first, then push "Other" to the end.
            const allergySelectOptions = medications.map(med => med.name).sort(); // 1. Map and sort the names first
            allergySelectOptions.push("Other");                                    // 2. Add "Other" to the very end


            const updateProgressBar = (step) => {
                const progressBar = document.getElementById('progressBar');
                const percentage = (step / totalSteps) * 100;
                progressBar.style.width = `${percentage}%`;
                progressBar.setAttribute('aria-valuenow', percentage);
            };

            const renderAllergyOptions = () => {
                // Get the new container for the 3-column grid
                const allergyGridContainer = document.getElementById('allergy-options-grid-container');
                const noAllergyOption = document.getElementById('no-allergy-option');
                
                allergyGridContainer.innerHTML = ''; // Clear the grid container
                
                // Add individual allergy options to the grid container
                allergySelectOptions.forEach(name => {
                    const option = document.createElement('div');
                    // Add the 'allergy-option' class for styling
                    option.className = 'allergy-option'; 
                    option.dataset.allergy = name;
                    option.textContent = name;
                    allergyGridContainer.appendChild(option);
                });

                // --- Event Listeners for new structure ---
                
                const allAllergyPills = document.querySelectorAll('#page-3b .allergy-option');

                // 1. Logic for "No known allergies" button
                noAllergyOption.addEventListener('click', () => {
                    // Deselect all pills in the grid
                    allergyGridContainer.querySelectorAll('.allergy-option').forEach(opt => opt.classList.remove('selected'));
                    // Select the full-width button
                    noAllergyOption.classList.add('selected');
                });
                
                // 2. Logic for all other allergy pills
                allergyGridContainer.querySelectorAll('.allergy-option').forEach(option => {
                    option.addEventListener('click', () => {
                        // Deselect "No known allergies" if another is clicked
                        noAllergyOption.classList.remove('selected');
                        option.classList.toggle('selected');
                        
                        // If no pills are selected, re-select "No known allergies"
                        const selectedCount = Array.from(allergyGridContainer.querySelectorAll('.allergy-option.selected')).length;
                        if (selectedCount === 0) {
                            noAllergyOption.classList.add('selected');
                        }
                    });
                });
            };

            const saveUserInfo = () => {
                const userInfo = {
                    firstName: firstNameInput.value.trim(),
                    lastName: lastNameInput.value.trim(),
                    email: emailInput.value.trim(),
                    phone: phoneInput.value.trim()
                };
                localStorage.setItem('wandrUserInfo', JSON.stringify(userInfo));
            };

            const loadUserInfo = () => {
                const userInfo = JSON.parse(localStorage.getItem('wandrUserInfo'));
                if (userInfo) {
                    firstNameInput.value = userInfo.firstName;
                    lastNameInput.value = userInfo.lastName;
                    emailInput.value = userInfo.email;
                    phoneInput.value = userInfo.phone;
                }
            };
            
            const showPage = (pageId) => {
                Object.values(pages).forEach(page => page.style.display = 'none');
                
                pages[pageId].style.display = 'block';

                const stepMap = { 'page-1': 1, 'page-2': 2, 'page-2b': 2, 'page-3': 3, 'page-3b': 3, 'page-4': 4 };
                updateProgressBar(stepMap[pageId]);

                // FIX 1: Disclaimer is removed, this conditional control is no longer needed
            };

            const validatePage1 = () => {
                const firstName = firstNameInput.value.trim();
                const lastName = lastNameInput.value.trim();
                const email = emailInput.value.trim();
                const phone = phoneInput.value.trim();

                const inputs = [firstNameInput, lastNameInput, emailInput, phoneInput];
                inputs.forEach(input => input.classList.remove('error-border'));
                
                let isValid = true;

                if (!firstName) {
                    firstNameInput.classList.add('error-border');
                    isValid = false;
                }
                if (!lastName) {
                    lastNameInput.classList.add('error-border');
                    isValid = false;
                }
                if (!email || !emailRegex.test(email)) {
                    emailInput.classList.add('error-border');
                    isValid = false;
                }
                if (!phone || !phoneRegex.test(phone)) {
                    phoneInput.classList.add('error-border');
                    isValid = false;
                }
                
                return isValid;
            };
            
            const renderMedicationList = () => {
                const selectedCountry = countrySelect.value;
                const destinationData = countries.find(c => c.name === selectedCountry);
                const destinationRisk = destinationData?.riskLevel;
                const isHighAltitude = altitudeSicknessSelection === 'yes' || (altitudeSicknessCountries.has(selectedCountry) && altitudeSicknessSelection !== 'no');
                const selectedAllergies = Array.from(document.querySelectorAll('#page-3b .allergy-option.selected')).map(el => el.dataset.allergy).filter(a => a !== 'none');

                let recommendedMeds = [];
                let totalMedPrice = 0;
                
                const getMedDetails = (name) => medications.find(m => m.name === name);
                const getLogic = (group) => medicationLogic.find(m => m.group === group);
                const getAllMedDetailsByRisk = (risk) => medications.filter(m => {
                    const logic = medicationLogic.find(l => l.name === m.name);
                    return logic && logic.risk.includes(risk);
                });

                
                // --- Step 1: Malaria ---
                const malariaMed = medications.find(m => m.group === 'malaria');
                if (malariaProphylaxisSelection === 'yes' && !selectedAllergies.includes(malariaMed.name)) {
                    recommendedMeds.push(malariaMed);
                }

                // --- Step 2: Traveler's Diarrhea ---
                if (destinationRisk !== 'low') {
                    const azithromycin = medications.find(m => m.group === "diarrhea");
                    const ciprofloxacin = medications.find(m => m.group === "diarrhea-alt");
                    // Check if the primary diarrhea med is an allergy, if so, use the alternative, otherwise use the primary
                    const diarrheaMed = selectedAllergies.includes(azithromycin.name) ? ciprofloxacin : azithromycin;
                    if (!selectedAllergies.includes(diarrheaMed.name)) {
                         recommendedMeds.push(diarrheaMed);
                    }
                }

                const meclizine = medications.find(m => m.group === "motion-sickness");
                const scopolamine = medications.find(m => m.group === "motion-sickness-alt");
                const motionSicknessMed = selectedAllergies.includes(meclizine.name) ? scopolamine : meclizine;
                if (!selectedAllergies.includes(motionSicknessMed.name)) {
                    recommendedMeds.push(motionSicknessMed);
                }
                
                // --- Step 4: Altitude Sickness ---
                if (isHighAltitude) {
                    const altitudeMed = medications.find(m => m.group === 'altitude');
                    if (!selectedAllergies.includes(altitudeMed.name)) {
                        recommendedMeds.push(altitudeMed);
                    }
                }
                
                // --- Step 5: Remaining General Risk Meds (pain, nausea, anxiety, cramps, skin) ---
                const riskMeds = medications.filter(med => med.risk.includes(destinationRisk));
                
                riskMeds.forEach(med => {
                    const isAlreadyAdded = recommendedMeds.some(rm => rm.group === med.group);
                    if (!isAlreadyAdded && med.group !== 'diarrhea-alt' && med.group !== 'motion-sickness-alt' && !selectedAllergies.includes(med.name)) {
                        recommendedMeds.push(med);
                    }
                });
                
                finalRecommendedMeds = recommendedMeds;

                medicationList.innerHTML = '';
                totalMedPrice = 0;

                // Update Country Info 
                countryNameEl.textContent = destinationData.name;
                riskLevelEl.textContent = destinationRisk.charAt(0).toUpperCase() + destinationRisk.slice(1);
                countryDescriptionEl.textContent = destinationData.description;

                // Update Malaria Alert
                if (destinationRisk === 'high' && malariaProphylaxisSelection === 'yes') {
                    malariaAlertEl.style.display = 'block';
                    malariaAlertEl.textContent = `${destinationData.name} is a malaria endemic area. We have included medication that is essential you take daily to prevent malaria.`;
                } else {
                    malariaAlertEl.style.display = 'none';
                }

                // FIX 3 & 4: Render with Ailment and Quantity subtext
                finalRecommendedMeds.forEach(med => {
                    const div = document.createElement('div');
                    div.className = 'medication-item';
                    div.innerHTML = `
                        <div>
                            <span class="med-name">${med.name} - ${med.ailment}</span>
                            <span class="med-details">${med.quantity}</span>
                        </div>
                        <span>$${med.price.toFixed(2)}</span>
                    `;
                    medicationList.appendChild(div);
                    totalMedPrice += med.price;
                });
                
                const savings = totalMedPrice - kitPrice;
                const savingsPercentage = totalMedPrice > 0 ? ((savings / totalMedPrice) * 100).toFixed(0) : 0;
                
                savingsAmountEl.textContent = `$${savings.toFixed(2)} (${savingsPercentage}% cheaper)`;
                medicationTotalPriceEl.textContent = `$${totalMedPrice.toFixed(2)}`;
            };

            const renderIndividualMeds = () => {
                individualMedsList.innerHTML = '';
                
                // FIX 2: Ensure correct column collapsing for centering
                medsListColumn.classList.add('full-width');
                priceSummaryColumn.style.display = 'none';

                // FIX 3 & 4: Render with Ailment and Quantity subtext for selection pills
                finalRecommendedMeds.forEach(med => {
                    const div = document.createElement('div');
                    
                    div.innerHTML = `
                        <div class="medication-card" data-variant-id="${med.variantId}" data-price="${med.price}">
                            <div>
                                <h6 style="font-weight: 500;">${med.name} - ${med.ailment}</h6>
                                <span class="med-details" style="font-weight: 500; text-align: left;">${med.quantity}</span> 
                            </div>
                            <span>$${med.price.toFixed(2)}</span>
                        </div>
                    `;
                    individualMedsList.appendChild(div);

                    const card = div.querySelector('.medication-card');
                    card.addEventListener('click', () => {
                        card.classList.toggle('selected');
                        // REMOVED: Manual style color manipulation. CSS now handles text color when .selected is applied.
                        updateIndividualMedsTotal();
                    });
                });
                updateIndividualMedsTotal();
            };

            const updateIndividualMedsTotal = () => {
                let total = 0;
                individualMedsList.querySelectorAll('.medication-card.selected').forEach(card => {
                    total += parseFloat(card.dataset.price);
                });
                individualMedsTotalPriceEl.textContent = `$${total.toFixed(2)}`;
                checkoutIndividualMedsButton.disabled = total === 0;
            };

            const generateIndividualCheckoutUrl = () => {
                const userInfo = JSON.parse(localStorage.getItem('wandrUserInfo'));
                if (!userInfo) {
                    alert("User info not found. Please go back to the first page and try again.");
                    return null;
                }
                
                const selectedMeds = Array.from(individualMedsList.querySelectorAll('.medication-card.selected'));

                if (selectedMeds.length === 0) {
                    alert("Please select at least one medication to proceed to checkout.");
                    return null;
                }

                const lineItems = selectedMeds.map(card => `${card.dataset.variantId}:1`).join(',');

                // You might need to adjust the domain if this is a development store.
                const url = `https://b0y2qj-6r.myshopify.com/cart/${lineItems}?checkout[email]=${encodeURIComponent(userInfo.email)}&checkout[shipping_address][first_name]=${encodeURIComponent(userInfo.firstName)}&checkout[shipping_address][last_name]=${encodeURIComponent(userInfo.lastName)}&checkout[shipping_address][phone]=${encodeURIComponent(userInfo.phone)}`;
                
                return url;
            };

            // --- CORE INITIALIZATION & EVENT ATTACHMENTS ---
            
            loadUserInfo();
            updateProgressBar(1);
            renderAllergyOptions();
            
            // FIX START BUTTON: This logic is guaranteed to work now.
            startButton.addEventListener('click', () => {
                if (validatePage1()) {
                    saveUserInfo();
                    showPage('page-2');
                } else {
                    alert("Please fill out all required fields to continue.");
                }
            });
            // FIX ENTER KEY
            document.getElementById('page-1').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    startButton.click();
                }
            });


            document.querySelector('[data-action="next-from-p2"]').addEventListener('click', () => {
                if (countrySelect.value === '' || countrySelect.value === 'Select a Country') {
                    alert("Please select a country to continue.");
                    countrySelect.classList.add('error-border');
                    return;
                }
                countrySelect.classList.remove('error-border');
                const selectedCountry = countrySelect.value;
                const destinationData = countries.find(c => c.name === selectedCountry);
                if (destinationData && destinationData.riskLevel === 'high' && malariaEndemicCountries.includes(selectedCountry)) {
                    showPage('page-2b');
                } else {
                    malariaProphylaxisSelection = null;
                    showPage('page-3');
                }
            });

            document.querySelector('[data-action="next-from-p2b"]').addEventListener('click', () => {
                if (!malariaProphylaxisSelection) {
                    alert("Please select an option to continue.");
                    return;
                }
                showPage('page-3');
            });

            document.querySelector('[data-action="next-from-p3"]').addEventListener('click', () => {
                 if (!altitudeSicknessSelection) {
                    alert("Please select an option to continue.");
                    return;
                }
                showPage('page-3b');
            });

            malariaOptions.forEach(option => {
                option.addEventListener('click', () => {
                    malariaOptions.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                    malariaProphylaxisSelection = option.dataset.selection;
                });
            });

            altitudeOptions.forEach(option => {
                option.addEventListener('click', () => {
                    altitudeOptions.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                    altitudeSicknessSelection = option.dataset.selection;
                });
            });

            document.querySelector('[data-action="get-results"]').addEventListener('click', () => {
                renderMedicationList();
                showPage('page-4');
                // Ensure recommended kit is shown by default on results
                recommendedMedsListContainer.style.display = 'block';
                recommendedKitSection.style.display = 'block';
                individualMedsSection.style.display = 'none';

                medsListColumn.classList.remove('full-width');
                priceSummaryColumn.style.display = 'block';
            });

            orderKitButton.addEventListener('click', (e) => {
                e.preventDefault();
                const userInfo = JSON.parse(localStorage.getItem('wandrUserInfo'));
                if (!userInfo) {
                    alert("User info not found. Please go back to the first page and try again.");
                    return;
                }
                
                const checkoutUrl = `https://b0y2qj-6r.myshopify.com/cart/${comprehensiveKitVariantId}:1?checkout[email]=${encodeURIComponent(userInfo.email)}&checkout[shipping_address][first_name]=${encodeURIComponent(userInfo.firstName)}&checkout[shipping_address][last_name]=${encodeURIComponent(userInfo.lastName)}&checkout[shipping_address][phone]=${encodeURIComponent(userInfo.phone)}`;
                
                window.location.href = checkoutUrl;
            });
            
            individualMedsButton.addEventListener('click', (e) => {
                e.preventDefault();
                // Switch to individual selection view
                recommendedMedsListContainer.style.display = 'none';
                recommendedKitSection.style.display = 'none';
                individualMedsSection.style.display = 'block';
                
                medsListColumn.classList.add('full-width'); // FIX 2: Enable full width for centering
                priceSummaryColumn.style.display = 'none';

                renderIndividualMeds();
            });

            checkoutIndividualMedsButton.addEventListener('click', (e) => {
                e.preventDefault();
                const checkoutUrl = generateIndividualCheckoutUrl();
                if (checkoutUrl) {
                    window.location.href = checkoutUrl;
                }
            });

            document.querySelector('[data-action="back-to-recommended-kit"]').addEventListener('click', () => {
                // Switch back to recommended kit view
                individualMedsSection.style.display = 'none';
                recommendedMedsListContainer.style.display = 'block';
                recommendedKitSection.style.display = 'block';
                
                medsListColumn.classList.remove('full-width'); // FIX 2: Disable full width
                priceSummaryColumn.style.display = 'block';
            });

            document.querySelector('[data-action="back-to-p1"]').addEventListener('click', () => showPage('page-1'));
            document.querySelector('[data-action="back-to-p2"]').addEventListener('click', () => showPage('page-2'));
            document.querySelector('[data-action="back-to-p2b"]').addEventListener('click', () => {
                const selectedCountry = countrySelect.value;
                const destinationData = countries.find(c => c.name === selectedCountry);
                if (destinationData && destinationData.riskLevel === 'high' && malariaEndemicCountries.includes(selectedCountry)) {
                    showPage('page-2b');
                } else {
                    showPage('page-2');
                }
            });
            document.querySelector('[data-action="back-to-p3"]').addEventListener('click', () => showPage('page-3'));

            // 💡 FIX: ADD THE EVENT LISTENER FOR THE NEW "CHANGE COUNTRY" LINK
            changeCountryLink.addEventListener('click', (e) => {
                e.preventDefault();
                showPage('page-2'); // Go back to the country selection page
            });
            
            durationMinus.addEventListener('click', () => {
                const currentVal = parseInt(durationInput.value);
                if (currentVal > 1) {
                    durationInput.value = currentVal - 1;
                }
            });

            durationPlus.addEventListener('click', () => {
                const currentVal = parseInt(durationInput.value);
                durationInput.value = currentVal + 1;
            });
            
        });
    </script>
</body>
</html>